"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.VolatileSessionsManager = void 0;
var faro_core_1 = require("@grafana/faro-core");
var utils_1 = require("../../../utils");
var webStorage_1 = require("../../../utils/webStorage");
var sampling_1 = require("./sampling");
var sessionConstants_1 = require("./sessionConstants");
var sessionManagerUtils_1 = require("./sessionManagerUtils");
var VolatileSessionsManager = /** @class */ (function () {
    function VolatileSessionsManager() {
        var _this = this;
        this.updateSession = (0, utils_1.throttle)(function () { return _this.updateUserSession(); }, sessionConstants_1.STORAGE_UPDATE_DELAY);
        this.updateUserSession = (0, sessionManagerUtils_1.getUserSessionUpdater)({
            fetchUserSession: VolatileSessionsManager.fetchUserSession,
            storeUserSession: VolatileSessionsManager.storeUserSession,
        });
        this.init();
    }
    VolatileSessionsManager.removeUserSession = function () {
        (0, webStorage_1.removeItem)(sessionConstants_1.STORAGE_KEY, VolatileSessionsManager.storageTypeSession);
    };
    VolatileSessionsManager.storeUserSession = function (session) {
        (0, webStorage_1.setItem)(sessionConstants_1.STORAGE_KEY, JSON.stringify(session), VolatileSessionsManager.storageTypeSession);
    };
    VolatileSessionsManager.fetchUserSession = function () {
        var storedSession = (0, webStorage_1.getItem)(sessionConstants_1.STORAGE_KEY, VolatileSessionsManager.storageTypeSession);
        if (storedSession) {
            return JSON.parse(storedSession);
        }
        return null;
    };
    VolatileSessionsManager.prototype.init = function () {
        var _this = this;
        document.addEventListener('visibilitychange', function () {
            if (document.visibilityState === 'visible') {
                _this.updateSession();
            }
        });
        // Users can call the setSession() method, so we need to sync this with the local storage session
        faro_core_1.faro.metas.addListener(function syncSessionIfChangedExternally(meta) {
            var session = meta.session;
            var sessionFromSessionStorage = VolatileSessionsManager.fetchUserSession();
            if (session && session.id !== (sessionFromSessionStorage === null || sessionFromSessionStorage === void 0 ? void 0 : sessionFromSessionStorage.sessionId)) {
                var userSession = (0, sessionManagerUtils_1.addSessionMetadataToNextSession)((0, sessionManagerUtils_1.createUserSessionObject)({ sessionId: session.id, isSampled: (0, sampling_1.isSampled)() }), sessionFromSessionStorage);
                VolatileSessionsManager.storeUserSession(userSession);
                faro_core_1.faro.api.setSession(userSession.sessionMeta);
            }
        });
    };
    VolatileSessionsManager.storageTypeSession = webStorage_1.webStorageType.session;
    return VolatileSessionsManager;
}());
exports.VolatileSessionsManager = VolatileSessionsManager;
//# sourceMappingURL=VolatileSessionManager.js.map