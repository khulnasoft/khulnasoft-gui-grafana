{"version":3,"file":"instrumentation.js","sourceRoot":"","sources":["../../../../src/instrumentations/session/instrumentation.ts"],"names":[],"mappings":"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","sourcesContent":["import {\n  BaseInstrumentation,\n  dateNow,\n  EVENT_SESSION_EXTEND,\n  EVENT_SESSION_RESUME,\n  EVENT_SESSION_START,\n  Meta,\n  MetaSession,\n  VERSION,\n} from '@grafana/faro-core';\nimport type { Config } from '@grafana/faro-core';\n\nimport type { TransportItem } from '../..';\nimport { createSession } from '../../metas';\n\nimport { type FaroUserSession, isSampled } from './sessionManager';\nimport { PersistentSessionsManager } from './sessionManager/PersistentSessionsManager';\nimport {\n  createUserSessionObject,\n  getSessionManagerByConfig,\n  isUserSessionValid,\n} from './sessionManager/sessionManagerUtils';\nimport type { SessionManager } from './sessionManager/types';\n\ntype LifecycleType = typeof EVENT_SESSION_RESUME | typeof EVENT_SESSION_START;\n\nexport class SessionInstrumentation extends BaseInstrumentation {\n  readonly name = '@grafana/faro-web-sdk:instrumentation-session';\n  readonly version = VERSION;\n\n  // previously notified session, to ensure we don't send session start\n  // event twice for the same session\n  private notifiedSession: MetaSession | undefined;\n\n  private sendSessionStartEvent(meta: Meta): void {\n    const session = meta.session;\n\n    if (session && session.id !== this.notifiedSession?.id) {\n      if (this.notifiedSession && this.notifiedSession.id === session.attributes?.['previousSession']) {\n        this.api.pushEvent(EVENT_SESSION_EXTEND, {}, undefined, { skipDedupe: true });\n        this.notifiedSession = session;\n        return;\n      }\n\n      this.notifiedSession = session;\n      // no need to add attributes and session id, they are included as part of meta\n      // automatically\n      this.api.pushEvent(EVENT_SESSION_START, {}, undefined, { skipDedupe: true });\n    }\n  }\n\n  private createInitialSession(\n    SessionManager: SessionManager,\n    sessionsConfig: Required<Config>['sessionTracking']\n  ): {\n    initialSession: FaroUserSession;\n    lifecycleType: LifecycleType;\n  } {\n    let userSession: FaroUserSession | null = SessionManager.fetchUserSession();\n\n    if (sessionsConfig.persistent && sessionsConfig.maxSessionPersistenceTime && userSession) {\n      const now = dateNow();\n      const shouldClearPersistentSession = userSession.lastActivity < now - sessionsConfig.maxSessionPersistenceTime;\n\n      if (shouldClearPersistentSession) {\n        PersistentSessionsManager.removeUserSession();\n        userSession = null;\n      }\n    }\n\n    let lifecycleType: LifecycleType;\n    let initialSession: FaroUserSession;\n\n    if (isUserSessionValid(userSession)) {\n      const sessionId = userSession?.sessionId;\n\n      initialSession = createUserSessionObject({\n        sessionId,\n        isSampled: userSession!.isSampled || false,\n        started: userSession?.started,\n      });\n\n      initialSession.sessionMeta = {\n        id: sessionId,\n        attributes: {\n          ...sessionsConfig.session?.attributes,\n          ...userSession?.sessionMeta?.attributes,\n          // For valid resumed sessions we do not want to recalculate the sampling decision on each init phase.\n          isSampled: initialSession.isSampled.toString(),\n        },\n      };\n\n      lifecycleType = EVENT_SESSION_RESUME;\n    } else {\n      const sessionId = sessionsConfig.session?.id ?? createSession().id;\n\n      initialSession = createUserSessionObject({\n        sessionId,\n        isSampled: isSampled(),\n      });\n\n      initialSession.sessionMeta = {\n        id: sessionId,\n        attributes: {\n          isSampled: initialSession.isSampled.toString(),\n          ...sessionsConfig.session?.attributes,\n        },\n      };\n\n      lifecycleType = EVENT_SESSION_START;\n    }\n\n    return { initialSession, lifecycleType };\n  }\n\n  private registerBeforeSendHook(SessionManager: SessionManager) {\n    const { updateSession } = new SessionManager();\n\n    this.transports?.addBeforeSendHooks((item) => {\n      updateSession();\n\n      const attributes = item.meta.session?.attributes;\n\n      if (attributes && attributes?.['isSampled'] === 'true') {\n        let newItem: TransportItem = JSON.parse(JSON.stringify(item));\n\n        const newAttributes = newItem.meta.session?.attributes;\n        delete newAttributes?.['isSampled'];\n\n        if (Object.keys(newAttributes ?? {}).length === 0) {\n          delete newItem.meta.session?.attributes;\n        }\n\n        return newItem;\n      }\n\n      return null;\n    });\n  }\n\n  initialize() {\n    this.logDebug('init session instrumentation');\n\n    const sessionTrackingConfig = this.config.sessionTracking;\n\n    if (sessionTrackingConfig?.enabled) {\n      const SessionManager = getSessionManagerByConfig(sessionTrackingConfig);\n\n      this.registerBeforeSendHook(SessionManager);\n\n      const { initialSession, lifecycleType } = this.createInitialSession(SessionManager, sessionTrackingConfig);\n\n      SessionManager.storeUserSession(initialSession);\n\n      const initialSessionMeta = initialSession.sessionMeta;\n\n      this.notifiedSession = initialSessionMeta;\n      this.api.setSession(initialSessionMeta);\n\n      if (lifecycleType === EVENT_SESSION_START) {\n        this.api.pushEvent(EVENT_SESSION_START, {}, undefined, { skipDedupe: true });\n      }\n\n      if (lifecycleType === EVENT_SESSION_RESUME) {\n        this.api.pushEvent(EVENT_SESSION_RESUME, {}, undefined, { skipDedupe: true });\n      }\n    }\n\n    this.metas.addListener(this.sendSessionStartEvent.bind(this));\n  }\n}\n"]}